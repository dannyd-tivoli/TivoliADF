{
	"name": "Fact_QEW",
	"properties": {
		"folder": {
			"name": "Tivoli Data Warehouse"
		},
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"dataset": {
						"referenceName": "PowerBI_db",
						"type": "DatasetReference"
					},
					"name": "QEWDetail"
				},
				{
					"dataset": {
						"referenceName": "TivoliDW_db",
						"type": "DatasetReference"
					},
					"name": "Project"
				}
			],
			"sinks": [
				{
					"dataset": {
						"referenceName": "TivoliDW_db",
						"type": "DatasetReference"
					},
					"name": "FactSync"
				}
			],
			"transformations": [
				{
					"name": "DerivedColumns"
				},
				{
					"name": "Staging"
				},
				{
					"name": "AlterRowSettings"
				},
				{
					"name": "ProjectLookup"
				}
			],
			"scriptLines": [
				"parameters{",
				"     LastRunDate as string (\"2022-05-09 00:00:00\")",
				"}",
				"source(output(",
				"          QuoteID as integer,",
				"          QEWDetailsID as integer,",
				"          RowNo as long,",
				"          OrganisationGroup as string,",
				"          Reference as string,",
				"          DateCreated as date,",
				"          DateCreatedID as integer,",
				"          TimeCreatedID as integer,",
				"          CompletedBy as string,",
				"          WorkDescription as string,",
				"          Site as string,",
				"          ClientContactName as string,",
				"          ClientContactNo as string,",
				"          ClientContactEmail as string,",
				"          ProjectCode as string,",
				"          QuoteStatus as string,",
				"          LastModifiedDateID as integer,",
				"          LastModifiedTimeID as integer,",
				"          TivoliNotes as string,",
				"          ClientComments as string,",
				"          CancelledReason as string,",
				"          ClientPONumber as string,",
				"          EWJobRaisedDateID as integer,",
				"          EWJobRaisedTimeID as integer,",
				"          EWJobReference as string,",
				"          EWJobID as integer,",
				"          EWJobStatus as string,",
				"          EWJobAllocatedTo as string,",
				"          EWJobCompletedDateID as integer,",
				"          EWJobCompletedTimeID as integer,",
				"          EWJobRejectedReason as string,",
				"          ApprovedDateID as integer,",
				"          ApprovedTimeID as integer,",
				"          AdditionalSiteInformation as string,",
				"          SiteAddress as string,",
				"          PostCode as string,",
				"          ClientApprover as string,",
				"          InvoiceNumber as string,",
				"          ItemClass as string,",
				"          ItemType as string,",
				"          Description as string,",
				"          Supplier as string,",
				"          CostRate as decimal(18,2),",
				"          Qty as decimal(18,6),",
				"          MarkupPerc as decimal(18,2),",
				"          RowAddedDate as timestamp",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     isolationLevel: 'READ_UNCOMMITTED',",
				"     inputs:['@LastModifedDate' -> ($LastRunDate)],",
				"     procedureName: 'sp_QEW_DW',",
				"     schemaName: 'dbo',",
				"     resultSet: true,",
				"     format: 'procedure') ~> QEWDetail",
				"source(output(",
				"          ProjectID as integer,",
				"          ProjectCode as string,",
				"          FromDate as date,",
				"          ToDate as date",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     isolationLevel: 'READ_UNCOMMITTED',",
				"     query: 'SELECT [ProjectID]\\n      ,[ProjectCode]\\n      ,[FromDate]\\n      ,[ToDate]\\n  FROM [DW].[DimProject]',",
				"     format: 'query') ~> Project",
				"ProjectLookup derive(LastModifiedDateTime = currentUTC('GMT'),",
				"          NewProjectID = iif(isNull(ProjectID), -1, ProjectID)) ~> DerivedColumns",
				"DerivedColumns select(mapColumn(",
				"          QuoteID,",
				"          QEWDetailsID,",
				"          RowNo,",
				"          OrganisationGroup,",
				"          Reference,",
				"          DateCreatedID,",
				"          TimeCreatedID,",
				"          CompletedBy,",
				"          WorkDescription,",
				"          Site,",
				"          ClientContactName,",
				"          ClientContactNo,",
				"          ClientContactEmail,",
				"          ProjectCode = QEWDetail@ProjectCode,",
				"          QuoteStatus,",
				"          LastModifiedDateID,",
				"          LastModifiedTimeID,",
				"          TivoliNotes,",
				"          ClientComments,",
				"          CancelledReason,",
				"          ClientPONumber,",
				"          EWJobRaisedDateID,",
				"          EWJobRaisedTimeID,",
				"          EWJobReference,",
				"          EWJobID,",
				"          EWJobStatus,",
				"          EWJobAllocatedTo,",
				"          EWJobCompletedDateID,",
				"          EWJobCompletedTimeID,",
				"          EWJobRejectedReason,",
				"          ApprovedDateID,",
				"          ApprovedTimeID,",
				"          AdditionalSiteInformation,",
				"          SiteAddress,",
				"          PostCode,",
				"          ClientApprover,",
				"          InvoiceNumber,",
				"          ItemClass,",
				"          ItemType,",
				"          Description,",
				"          Supplier,",
				"          CostRate,",
				"          Qty,",
				"          MarkupPerc,",
				"          RowAddedDate,",
				"          LastModifiedDateTime,",
				"          ProjectID = NewProjectID",
				"     ),",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true) ~> Staging",
				"Staging alterRow(upsertIf(true())) ~> AlterRowSettings",
				"QEWDetail, Project lookup(QEWDetail@ProjectCode == Project@ProjectCode",
				"     && DateCreated >= FromDate",
				"     && DateCreated <= ToDate,",
				"     multiple: false,",
				"     pickup: 'any',",
				"     broadcast: 'right')~> ProjectLookup",
				"AlterRowSettings sink(allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     deletable:false,",
				"     insertable:false,",
				"     updateable:false,",
				"     upsertable:true,",
				"     keys:['QuoteID','QEWDetailsID'],",
				"     skipKeyWrites:true,",
				"     format: 'table',",
				"     batchSize: 10000,",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true,",
				"     errorHandlingOption: 'stopOnFirstError',",
				"     mapColumn(",
				"          QuoteID,",
				"          QEWDetailsID,",
				"          RowNo,",
				"          OrganisationGroup,",
				"          Reference,",
				"          DateCreatedID,",
				"          TimeCreatedID,",
				"          CompletedBy,",
				"          WorkDescription,",
				"          Site,",
				"          ClientContactName,",
				"          ClientContactNo,",
				"          ClientContactEmail,",
				"          QuoteStatus,",
				"          LastModifiedDateID,",
				"          LastModifiedTimeID,",
				"          TivoliNotes,",
				"          ClientComments,",
				"          CancelledReason,",
				"          ClientPONumber,",
				"          EWJobRaisedDateID,",
				"          EWJobRaisedTimeID,",
				"          EWJobReference,",
				"          EWJobID,",
				"          EWJobStatus,",
				"          EWJobAllocatedTo,",
				"          EWJobCompletedDateID,",
				"          EWJobCompletedTimeID,",
				"          EWJobRejectedReason,",
				"          ApprovedDateID,",
				"          ApprovedTimeID,",
				"          AdditionalSiteInformation,",
				"          SiteAddress,",
				"          PostCode,",
				"          ClientApprover,",
				"          InvoiceNumber,",
				"          ItemClass,",
				"          ItemType,",
				"          Description,",
				"          Supplier,",
				"          CostRate,",
				"          Qty,",
				"          MarkupPerc,",
				"          RowAddedDate,",
				"          LastModifiedDateTime,",
				"          ProjectID",
				"     )) ~> FactSync"
			]
		}
	}
}