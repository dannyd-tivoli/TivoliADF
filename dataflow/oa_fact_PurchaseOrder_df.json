{
	"name": "oa_fact_PurchaseOrder_df",
	"properties": {
		"folder": {
			"name": "Tivoli Data Warehouse"
		},
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"dataset": {
						"referenceName": "Reception_db",
						"type": "DatasetReference"
					},
					"name": "podetail"
				},
				{
					"dataset": {
						"referenceName": "TivoliDW_db",
						"type": "DatasetReference"
					},
					"name": "Supplier"
				},
				{
					"dataset": {
						"referenceName": "TivoliDW_db",
						"type": "DatasetReference"
					},
					"name": "ActivityCode"
				},
				{
					"dataset": {
						"referenceName": "TivoliDW_db",
						"type": "DatasetReference"
					},
					"name": "WorkStage"
				},
				{
					"dataset": {
						"referenceName": "TivoliDW_db",
						"type": "DatasetReference"
					},
					"name": "Project"
				}
			],
			"sinks": [
				{
					"dataset": {
						"referenceName": "FactPO",
						"type": "DatasetReference"
					},
					"name": "FactSync"
				}
			],
			"transformations": [
				{
					"name": "DerivedColumns"
				},
				{
					"name": "Staging"
				},
				{
					"name": "AlterRowSettings"
				},
				{
					"name": "WorkStageLookup"
				},
				{
					"name": "ProjectLookup"
				},
				{
					"name": "SupplierLookup"
				},
				{
					"name": "ActivityCodeLookup"
				}
			],
			"scriptLines": [
				"parameters{",
				"     LastRunDate as string (\"2022-05-09 00:00:00\")",
				"}",
				"source(output(",
				"          OrderNumber as integer,",
				"          OrderReference as string,",
				"          SupplierCode as string,",
				"          OrderDate as date,",
				"          RevDate as date,",
				"          OrderValue as decimal(17,2),",
				"          CreatedDate as date,",
				"          OrderStatus as string,",
				"          DeliveryPostCode as string,",
				"          Branch as string,",
				"          RecordType as string,",
				"          OutstandingValue as decimal(17,2),",
				"          CustomerReference as string,",
				"          CurrencyCode as string,",
				"          CurrencyRate as decimal(21,6),",
				"          OrderBaseValue as decimal(17,2),",
				"          OrderBaseOutstanding as decimal(17,2),",
				"          Period as integer,",
				"          Year as string,",
				"          CreatedTimeID as integer,",
				"          EndDate as date,",
				"          RequestedBy as string,",
				"          DeliveryAddress as string,",
				"          InvoiceAddress as string,",
				"          OrderAddress as string,",
				"          OrderPostCode as string,",
				"          MatchDate as date,",
				"          LineNo as integer,",
				"          LineTotal as decimal(17,2),",
				"          Price as decimal(17,5),",
				"          Discount as decimal(17,2),",
				"          Quantity as decimal(18,3),",
				"          OutStandingTotal as decimal(17,2),",
				"          ItemDescription as string,",
				"          Units as string,",
				"          VatCode as string,",
				"          ActivityCode as string,",
				"          OutstandingQty as decimal(18,3),",
				"          LineStatus as string,",
				"          AllocatedQty as decimal(18,3),",
				"          DispatchedQty as decimal(18,3),",
				"          UnderPickedQty as decimal(18,3),",
				"          NewPrice as decimal(17,5),",
				"          BaseValue as decimal(17,2),",
				"          BaseValueOutstanding as decimal(17,2),",
				"          DueDate as date,",
				"          BasePrice as decimal(17,5),",
				"          Project as string,",
				"          AmendmentDate as date,",
				"          Workstage as string,",
				"          OALastModifiedDateTime as string,",
				"          UpdatedDateTime as timestamp,",
				"          OrderDateID as integer,",
				"          RevDateID as integer,",
				"          CreatedDateID as integer,",
				"          MatchDateID as integer,",
				"          DueDateID as integer,",
				"          AmendmentDateID as integer,",
				"          EndDateID as integer",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     isolationLevel: 'READ_UNCOMMITTED',",
				"     inputs:['@LastModifedDate' -> ($LastRunDate)],",
				"     procedureName: 'sp_oa_podetail_DW',",
				"     schemaName: 'dbo',",
				"     resultSet: true,",
				"     format: 'procedure') ~> podetail",
				"source(output(",
				"          SupplierID as integer,",
				"          SupplierCode as string,",
				"          FromDate as date,",
				"          ToDate as date",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     isolationLevel: 'READ_UNCOMMITTED',",
				"     query: 'SELECT  [SupplierID]\\n      ,[SupplierCode]\\n      ,[FromDate]\\n      ,[ToDate]\\n  FROM [DW].[DimSupplier]',",
				"     format: 'query') ~> Supplier",
				"source(output(",
				"          ActivityCodeID as integer,",
				"          ActivityCode as string,",
				"          FromDate as date,",
				"          ToDate as date",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     isolationLevel: 'READ_UNCOMMITTED',",
				"     query: 'SELECT [ActivityCodeID]\\n      ,[ActivityCode]\\n      ,[FromDate]\\n      ,[ToDate]\\n  FROM [DW].[DimActivityCode]',",
				"     format: 'query') ~> ActivityCode",
				"source(output(",
				"          WorkStageID as integer,",
				"          WorkStageCode as string,",
				"          FromDate as date,",
				"          ToDate as date",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     isolationLevel: 'READ_UNCOMMITTED',",
				"     query: 'SELECT [WorkStageID]\\n      ,[WorkStageCode]\\n       ,[FromDate]\\n       ,[ToDate]\\n  FROM [DW].[DimWorkStage]',",
				"     format: 'query') ~> WorkStage",
				"source(output(",
				"          ProjectID as integer,",
				"          ProjectCode as string,",
				"          FromDate as date,",
				"          ToDate as date",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     isolationLevel: 'READ_UNCOMMITTED',",
				"     query: 'SELECT [ProjectID]\\n      ,[ProjectCode]\\n      ,[FromDate]\\n      ,[ToDate]\\n  FROM [DW].[DimProject]',",
				"     format: 'query') ~> Project",
				"ProjectLookup derive(NewSupplierID = iif(isNull(SupplierID), -1,SupplierID),",
				"          NewActivityCodeID = iif(isNull(ActivityCodeID), -1, ActivityCodeID),",
				"          LastModifiedDateTime = currentUTC('GMT'),",
				"          Period = toInteger(Period),",
				"          NewWorkStageID = iif(isNull(WorkStageID), -1, WorkStageID),",
				"          NewProjectID = iif(isNull(ProjectID), -1, ProjectID)) ~> DerivedColumns",
				"DerivedColumns select(mapColumn(",
				"          OrderNumber,",
				"          OrderReference,",
				"          OrderValue,",
				"          OrderStatus,",
				"          DeliveryPostCode,",
				"          Branch,",
				"          RecordType,",
				"          OutstandingValue,",
				"          CustomerReference,",
				"          CurrencyCode,",
				"          CurrencyRate,",
				"          OrderBaseValue,",
				"          OrderBaseOutstanding,",
				"          Period,",
				"          Year,",
				"          CreatedTimeID,",
				"          RequestedBy,",
				"          DeliveryAddress,",
				"          InvoiceAddress,",
				"          OrderAddress,",
				"          OrderPostCode,",
				"          MatchDate,",
				"          LineNo,",
				"          LineTotal,",
				"          Price,",
				"          Discount,",
				"          Quantity,",
				"          OutStandingTotal,",
				"          ItemDescription,",
				"          Units,",
				"          VatCode,",
				"          OutstandingQty,",
				"          LineStatus,",
				"          AllocatedQty,",
				"          DispatchedQty,",
				"          UnderPickedQty,",
				"          NewPrice,",
				"          BaseValue,",
				"          BaseValueOutstanding,",
				"          BasePrice,",
				"          Project,",
				"          SupplierID = NewSupplierID,",
				"          ActivityCodeID = NewActivityCodeID,",
				"          WorkStageID = NewWorkStageID,",
				"          ProjectID = NewProjectID,",
				"          OrderDateID,",
				"          RevDateID,",
				"          CreatedDateID,",
				"          MatchDateID,",
				"          DueDateID,",
				"          AmendmentDateID,",
				"          EndDateID,",
				"          LastModifiedDateTime",
				"     ),",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true) ~> Staging",
				"Staging alterRow(upsertIf(true())) ~> AlterRowSettings",
				"ActivityCodeLookup, WorkStage lookup(Workstage == WorkStageCode",
				"     && OrderDate >= WorkStage@FromDate",
				"     && OrderDate <= WorkStage@ToDate,",
				"     multiple: false,",
				"     pickup: 'any',",
				"     broadcast: 'right')~> WorkStageLookup",
				"WorkStageLookup, Project lookup(Project == ProjectCode",
				"     && OrderDate >= Project@FromDate",
				"     && OrderDate <= Project@ToDate,",
				"     multiple: false,",
				"     pickup: 'any',",
				"     broadcast: 'right')~> ProjectLookup",
				"podetail, Supplier lookup(podetail@SupplierCode == Supplier@SupplierCode",
				"     && OrderDate >= FromDate",
				"     && OrderDate <= ToDate,",
				"     multiple: false,",
				"     pickup: 'any',",
				"     broadcast: 'right')~> SupplierLookup",
				"SupplierLookup, ActivityCode lookup(podetail@ActivityCode == ActivityCode@ActivityCode",
				"     && OrderDate >= ActivityCode@FromDate",
				"     && OrderDate <= ActivityCode@ToDate,",
				"     multiple: false,",
				"     pickup: 'any',",
				"     broadcast: 'right')~> ActivityCodeLookup",
				"AlterRowSettings sink(allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     input(",
				"          ID as integer,",
				"          ActivityCodeID as integer,",
				"          SupplierID as integer,",
				"          ProjectID as integer,",
				"          WorkstageID as integer,",
				"          OrderDateID as integer,",
				"          RevDateID as integer,",
				"          CreatedDateID as integer,",
				"          CreatedTimeID as integer,",
				"          DueDateID as integer,",
				"          EndDateID as integer,",
				"          MatchDateID as integer,",
				"          AmendmentDateID as integer,",
				"          OrderNumber as integer,",
				"          OrderReference as string,",
				"          OrderValue as decimal(18,2),",
				"          OrderStatus as string,",
				"          DeliveryPostCode as string,",
				"          Branch as string,",
				"          RecordType as string,",
				"          OutstandingValue as decimal(18,2),",
				"          CustomerReference as string,",
				"          CurrencyCode as string,",
				"          CurrencyRate as decimal(21,6),",
				"          OrderBaseValue as decimal(18,2),",
				"          OrderBaseOutstanding as decimal(18,2),",
				"          Period as integer,",
				"          Year as string,",
				"          RequestedBy as string,",
				"          DeliveryAddress as string,",
				"          InvoiceAddress as string,",
				"          OrderAddress as string,",
				"          OrderPostCode as string,",
				"          LineNo as integer,",
				"          LineTotal as decimal(18,2),",
				"          Price as decimal(17,5),",
				"          Discount as decimal(18,2),",
				"          Quantity as decimal(18,3),",
				"          OutStandingTotal as decimal(18,2),",
				"          ItemDescription as string,",
				"          Units as string,",
				"          VatCode as string,",
				"          OutstandingQty as decimal(18,3),",
				"          LineStatus as string,",
				"          AllocatedQty as decimal(18,3),",
				"          DispatchedQty as decimal(18,3),",
				"          UnderPickedQty as decimal(18,3),",
				"          NewPrice as decimal(17,5),",
				"          BaseValue as decimal(18,2),",
				"          BaseValueOutstanding as decimal(18,2),",
				"          BasePrice as decimal(17,5),",
				"          LastModifiedDateTime as timestamp",
				"     ),",
				"     deletable:false,",
				"     insertable:false,",
				"     updateable:false,",
				"     upsertable:true,",
				"     keys:['Branch','RecordType','OrderNumber','LineNo'],",
				"     format: 'table',",
				"     batchSize: 10000,",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true,",
				"     errorHandlingOption: 'stopOnFirstError',",
				"     mapColumn(",
				"          ActivityCodeID,",
				"          SupplierID,",
				"          ProjectID,",
				"          WorkstageID = WorkStageID,",
				"          OrderDateID,",
				"          RevDateID = REvDateID,",
				"          CreatedDateID,",
				"          CreatedTimeID,",
				"          DueDateID,",
				"          EndDateID,",
				"          MatchDateID,",
				"          AmendmentDateID,",
				"          OrderNumber,",
				"          OrderReference,",
				"          OrderValue,",
				"          OrderStatus,",
				"          DeliveryPostCode,",
				"          Branch,",
				"          RecordType,",
				"          OutstandingValue,",
				"          CustomerReference,",
				"          CurrencyCode,",
				"          CurrencyRate,",
				"          OrderBaseValue,",
				"          OrderBaseOutstanding,",
				"          Period,",
				"          Year,",
				"          RequestedBy,",
				"          DeliveryAddress,",
				"          InvoiceAddress,",
				"          OrderAddress,",
				"          OrderPostCode,",
				"          LineNo,",
				"          LineTotal,",
				"          Price,",
				"          Discount,",
				"          Quantity,",
				"          OutStandingTotal,",
				"          ItemDescription,",
				"          Units,",
				"          VatCode,",
				"          OutstandingQty,",
				"          LineStatus,",
				"          AllocatedQty,",
				"          DispatchedQty,",
				"          UnderPickedQty,",
				"          NewPrice,",
				"          BaseValue,",
				"          BaseValueOutstanding,",
				"          BasePrice,",
				"          LastModifiedDateTime",
				"     )) ~> FactSync"
			]
		}
	}
}