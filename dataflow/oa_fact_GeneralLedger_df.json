{
	"name": "oa_fact_GeneralLedger_df",
	"properties": {
		"folder": {
			"name": "Tivoli Data Warehouse"
		},
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"dataset": {
						"referenceName": "Reception_db",
						"type": "DatasetReference"
					},
					"name": "nltrans"
				},
				{
					"dataset": {
						"referenceName": "TivoliDW_db",
						"type": "DatasetReference"
					},
					"name": "CostCentre"
				},
				{
					"dataset": {
						"referenceName": "TivoliDW_db",
						"type": "DatasetReference"
					},
					"name": "DocumentType"
				},
				{
					"dataset": {
						"referenceName": "TivoliDW_db",
						"type": "DatasetReference"
					},
					"name": "TransactionType"
				},
				{
					"dataset": {
						"referenceName": "TivoliDW_db",
						"type": "DatasetReference"
					},
					"name": "ActivityCode"
				},
				{
					"dataset": {
						"referenceName": "TivoliDW_db",
						"type": "DatasetReference"
					},
					"name": "Customer"
				},
				{
					"dataset": {
						"referenceName": "TivoliDW_db",
						"type": "DatasetReference"
					},
					"name": "Supplier"
				}
			],
			"sinks": [
				{
					"dataset": {
						"referenceName": "FactGL",
						"type": "DatasetReference"
					},
					"name": "FactSync"
				}
			],
			"transformations": [
				{
					"name": "CosstCentreLookup"
				},
				{
					"name": "DerivedColumns"
				},
				{
					"name": "Staging"
				},
				{
					"name": "DocTypeLookup"
				},
				{
					"name": "TransactionTypeLookup"
				},
				{
					"name": "AlterRowSettings"
				},
				{
					"name": "ActivityCodeLookup"
				},
				{
					"name": "CustomerLookup"
				},
				{
					"name": "SupplierLookup"
				}
			],
			"scriptLines": [
				"parameters{",
				"     LastRunDate as string (\"2022-05-09 00:00:00\")",
				"}",
				"source(output(",
				"          ID as integer,",
				"          unqkey as string,",
				"          {doc-id} as string,",
				"          docdate as date,",
				"          sourceacc as string,",
				"          sourceref as string,",
				"          orderref as string,",
				"          originref as string,",
				"          description as string,",
				"          baseval as decimal(17,2),",
				"          daybook as boolean,",
				"          currvalue as decimal(17,2),",
				"          qty as decimal(18,3),",
				"          yearno as decimal(15,0),",
				"          period as decimal(15,0),",
				"          batchref as string,",
				"          trtyp as string,",
				"          uuserid as string,",
				"          inputdate as date,",
				"          inputtime as integer,",
				"          stat as string,",
				"          costcentre as string,",
				"          expensecode as string,",
				"          docnumber as integer,",
				"          {vat-code} as string,",
				"          transdate as date,",
				"          {nrv-value} as decimal(17,2),",
				"          secval as decimal(17,2),",
				"          line_no as integer,",
				"          postdate as date,",
				"          qunit as string,",
				"          upuser as string,",
				"          upddate as date,",
				"          updtime as integer,",
				"          UpdatedDateTime as timestamp",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     isolationLevel: 'READ_UNCOMMITTED',",
				"     inputs:['@LastModifedDate' -> ($LastRunDate)],",
				"     procedureName: 'sp_oa_nltrans_DW',",
				"     schemaName: 'dbo',",
				"     resultSet: true,",
				"     format: 'procedure') ~> nltrans",
				"source(output(",
				"          CostCentreID as integer,",
				"          CostCentre as string,",
				"          FromDate as date,",
				"          ToDate as date",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     isolationLevel: 'READ_UNCOMMITTED',",
				"     query: 'SELECT [CostCentreID]\\n      ,[CostCentre]\\n      ,[FromDate]\\n      ,[ToDate]\\n       FROM [DW].[DimCostCentre]',",
				"     format: 'query') ~> CostCentre",
				"source(output(",
				"          DocumentTypeID as integer,",
				"          DocID as string",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     isolationLevel: 'READ_UNCOMMITTED',",
				"     query: 'SELECT [DocumentTypeID]\\n      ,[DocID]\\n  FROM [DW].[DimDocumentType]',",
				"     format: 'query') ~> DocumentType",
				"source(output(",
				"          TransactionTypeID as integer,",
				"          trtyp as string,",
				"          LedgerCode as string",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     isolationLevel: 'READ_UNCOMMITTED',",
				"     query: 'SELECT[TransactionTypeID]\\n      ,[trtyp], [LedgerCode]\\n  FROM [DW].[DimTransactionType]',",
				"     format: 'query') ~> TransactionType",
				"source(output(",
				"          ActivityCodeID as integer,",
				"          ActivityCode as string,",
				"          FromDate as date,",
				"          ToDate as date",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     isolationLevel: 'READ_UNCOMMITTED',",
				"     query: 'SELECT [ActivityCodeID]\\n      ,[ActivityCode]\\n      ,[FromDate]\\n      ,[ToDate]\\n  FROM [DW].[DimActivityCode]',",
				"     format: 'query') ~> ActivityCode",
				"source(output(",
				"          CustomerID as integer,",
				"          CustomerCode as string,",
				"          FromDate as date,",
				"          ToDate as date,",
				"          LedgerCode as string",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     isolationLevel: 'READ_UNCOMMITTED',",
				"     query: 'SELECT[CustomerID]\\n      ,[CustomerCode]\\n      ,[FromDate]\\n      ,[ToDate]\\n       ,\\'SL\\' AS [LedgerCode]\\n FROM [DW].[DimCustomer]',",
				"     format: 'query') ~> Customer",
				"source(output(",
				"          SupplierID as integer,",
				"          SupplierCode as string,",
				"          FromDate as date,",
				"          ToDate as date,",
				"          LedgerCode as string",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     isolationLevel: 'READ_UNCOMMITTED',",
				"     query: 'SELECT [SupplierID]\\n      ,[SupplierCode]\\n      ,[FromDate]\\n      ,[ToDate]\\n       ,\\'PL\\' AS [LedgerCode]\\n  FROM [DW].[DimSupplier]',",
				"     format: 'query') ~> Supplier",
				"DocTypeLookup, CostCentre lookup(nltrans@costcentre == CostCentre@CostCentre",
				"     && docdate >= FromDate",
				"     && docdate <= ToDate,",
				"     multiple: false,",
				"     pickup: 'any',",
				"     broadcast: 'right')~> CosstCentreLookup",
				"SupplierLookup derive(NewCostCentreID = iif(isNull(CostCentreID), -1,CostCentreID),",
				"          NewDocumentID = iif(isNull(DocumentTypeID), -1, DocumentTypeID),",
				"          NewTransactionTypeID = iif(isNull(TransactionTypeID), -1, TransactionTypeID),",
				"          LastModifiedDate = currentUTC('GMT'),",
				"          NewActivityCodeID = iif(isNull(ActivityCodeID), -1, ActivityCodeID),",
				"          DocumentDateID = toInteger(toString(docdate, 'yyyyddMM')),",
				"          InputDateID = toInteger(toString(inputdate, 'yyyyddMM')),",
				"          TransactionDateID = toInteger(toString(transdate, 'yyyyddMM')),",
				"          YearNo = toInteger(yearno),",
				"          Period = toInteger(period)) ~> DerivedColumns",
				"DerivedColumns select(mapColumn(",
				"          unqkey,",
				"          DocumentDateID,",
				"          CostCentreID = NewCostCentreID,",
				"          DocumentTypeID = NewDocumentID,",
				"          TransactionTypeID = NewTransactionTypeID,",
				"          LastModifiedDateTime = LastModifiedDate,",
				"          ActivityCodeID = NewActivityCodeID,",
				"          CustomerID,",
				"          SupplierID,",
				"          SourceReference = sourceref,",
				"          OrderReference = orderref,",
				"          OriginReference = originref,",
				"          Description = description,",
				"          BaseValue = baseval,",
				"          CurrentValue = currvalue,",
				"          Quantity = qty,",
				"          QuantityUnits = qunit,",
				"          YearNo = DerivedColumns@YearNo,",
				"          Period = DerivedColumns@Period,",
				"          BatchReference = batchref,",
				"          InputDateID,",
				"          InputTimeID = inputtime,",
				"          DocumentNumber = docnumber,",
				"          VatCode = {vat-code},",
				"          LineNo = line_no,",
				"          TransactionDateID",
				"     ),",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true) ~> Staging",
				"nltrans, DocumentType lookup({doc-id} == DocID,",
				"     multiple: false,",
				"     pickup: 'any',",
				"     broadcast: 'right')~> DocTypeLookup",
				"CosstCentreLookup, TransactionType lookup(nltrans@trtyp == TransactionType@trtyp,",
				"     multiple: false,",
				"     pickup: 'any',",
				"     broadcast: 'right')~> TransactionTypeLookup",
				"Staging alterRow(upsertIf(true())) ~> AlterRowSettings",
				"TransactionTypeLookup, ActivityCode lookup(expensecode == ActivityCode",
				"     && docdate >= ActivityCode@FromDate",
				"     && docdate <= ActivityCode@ToDate,",
				"     multiple: false,",
				"     pickup: 'any',",
				"     broadcast: 'right')~> ActivityCodeLookup",
				"ActivityCodeLookup, Customer lookup(sourceacc == CustomerCode",
				"     && docdate >= Customer@FromDate",
				"     && docdate <= Customer@ToDate",
				"     && TransactionType@LedgerCode == Customer@LedgerCode,",
				"     multiple: false,",
				"     pickup: 'any',",
				"     broadcast: 'right')~> CustomerLookup",
				"CustomerLookup, Supplier lookup(sourceacc == SupplierCode",
				"     && docdate >= Supplier@FromDate",
				"     && docdate <= Supplier@ToDate",
				"     && TransactionType@LedgerCode == Supplier@LedgerCode,",
				"     multiple: false,",
				"     pickup: 'any',",
				"     broadcast: 'right')~> SupplierLookup",
				"AlterRowSettings sink(allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     input(",
				"          ID as integer,",
				"          unqkey as string,",
				"          BatchReference as string,",
				"          DocumentNumber as integer,",
				"          LineNo as integer,",
				"          CostCentreID as integer,",
				"          DocumentTypeID as integer,",
				"          TransactionTypeID as integer,",
				"          ActivityCodeID as integer,",
				"          TransactionDateID as integer,",
				"          DocumentDateID as integer,",
				"          InputDateID as integer,",
				"          InputTimeID as integer,",
				"          CustomerID as integer,",
				"          SupplierID as integer,",
				"          YearNo as integer,",
				"          Period as integer,",
				"          SourceReference as string,",
				"          OrderReference as string,",
				"          OriginReference as string,",
				"          Description as string,",
				"          BaseValue as decimal(18,2),",
				"          CurrentValue as decimal(18,2),",
				"          Quantity as decimal(18,3),",
				"          QuantityUnits as string,",
				"          VatCode as string,",
				"          LastModifiedDateTime as timestamp",
				"     ),",
				"     deletable:false,",
				"     insertable:false,",
				"     updateable:false,",
				"     upsertable:true,",
				"     keys:['unqkey'],",
				"     format: 'table',",
				"     batchSize: 10000,",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true,",
				"     errorHandlingOption: 'stopOnFirstError',",
				"     mapColumn(",
				"          unqkey,",
				"          BatchReference,",
				"          DocumentNumber,",
				"          LineNo,",
				"          CostCentreID,",
				"          DocumentTypeID,",
				"          TransactionTypeID,",
				"          ActivityCodeID,",
				"          TransactionDateID,",
				"          DocumentDateID,",
				"          InputDateID,",
				"          InputTimeID,",
				"          CustomerID,",
				"          SupplierID,",
				"          YearNo,",
				"          Period,",
				"          SourceReference,",
				"          OrderReference,",
				"          OriginReference,",
				"          Description,",
				"          BaseValue,",
				"          CurrentValue,",
				"          Quantity,",
				"          QuantityUnits,",
				"          VatCode,",
				"          LastModifiedDateTime",
				"     )) ~> FactSync"
			]
		}
	}
}